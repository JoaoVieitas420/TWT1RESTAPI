const { joinCluster, heartbeatCheck } = require('../agent-update');
const { exec, spawn } = require('child_process');
const request = require('request-promise');
const { join } = require('path');


module.exports = (program) => {
    program
        .version('0.0.1')
        .command('worker')
        .option('--port [port]', 'Define port')
        .option('--dir [dir]', 'Define directory for task data and/or definition')
        .option('--address [address]', 'Joins a cluster with master address')
        .action(async cmd => {
            if (!cmd.dir) {
                console.log("Add a directory using --dir. Path must be absolute");
            }
            if (!cmd.address) {
                console.log('Add cluster address for connecting worker to a cluster');
            }

            else {

                try {
                    await joinCluster(cmd.address, cmd.port, cmd.dir, false, true);

                    try {
                        let child = spawn('node', [join(__dirname, '../server-process.js'), cmd.port], {
                            detached: true
                        });

                        child.stderr.on('data', (data) => {
                            console.log('Error while listening to port', cmd.port, data);
                        });

                       await heartbeatCheck();

                    }
                    catch (err) {
                        console.log(err);
                    }

                }
                catch (err) {

                    return console.log("Can not connect to cluster address", err);
                }



            }
            process.exit();
        });
}


