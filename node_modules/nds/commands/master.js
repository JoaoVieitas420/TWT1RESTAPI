const { addAgent, joinCluster } = require('../agent-update');
const { exec, spawn } = require('child_process');
const { join } = require('path');
const fs = require('fs');

module.exports = (program) => {
    program
        .version('0.0.1')
        .command('master')
        .option('--port [port]', 'Define port')
        .option('--dir [dir]', 'Define directory for task data and/or definition')
        .option('--worker', 'Add master node as worker too')
        .option('--address [address]', 'Joins a cluster with master address')
        .action(async cmd => {
            if (cmd.woker && !cmd.dir) {
                console.log("Add a directory using --dir. Path must be absolute");
            }
            else {
                try {
                    console.log(join(__dirname, '../server-process.js'));

                    const out = fs.openSync(join(__dirname, '../master.log'), 'a'),
                        err = fs.openSync(join(__dirname, '../master.log'), 'a');

                    let child = spawn('node', [join(__dirname, '../server-process.js'), cmd.port], {
                        detached: true,
                        stdio: ['ignore', out, err]
                    });

                    // child.stderr.on('data', (data) => {
                    //     console.log('Error while listening to port', cmd.port, data.toString());
                    // });

                    if (cmd.address) {
                        try {
                            await joinCluster(cmd.address, cmd.port, cmd.dir, true, !!cmd.worker)
                        }
                        catch (err) {
                            console.log("Can not connect to cluster address");
                        }
                    }
                    else {
                        await addAgent(cmd.port, true, !!cmd.worker, cmd.dir);
                    }

                }
                catch (err) {
                    console.log(err);
                }

            }
            process.exit()
        });

}