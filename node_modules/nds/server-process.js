const express = require('express');
var bodyParser = require('body-parser')
const { join } = require('path');

const { addAgentWithIpAdd, statsUpdate } = require('./agent-update');

var app = express()


app
    .use(bodyParser.urlencoded({ extended: false }))

    .use(bodyParser.json())

    .post('/heartbeat', async (req, res) => {
        const { stats, ip } = req.body;
        console.log({ stats, ip });
        await statsUpdate(ip, stats);
        res.send({ alive: true });
    })
    .get('/agent-info', (req, res) => {
        res.send(require('fs').readFileSync(join(__dirname , '/agents.json'), 'utf8'));
    })
    .get('/tasks', (req, res) => {
        //share task info
    })
    .get('/exec-task/:task', (req, res) => {

    })
    .post('/agents', (req, res) => {
        const { agents } = req.body;
        res.send(agents);
        require('fs').writeFileSync(join(__dirname, './agents.json'), JSON.stringify(agents), { encoding: 'utf8' });
    })
    .post('/add-agent', (req, res) => {
        const { ip, port, dir, master, worker } = req.body;
        try {
            addAgentWithIpAdd(ip, port, master, worker, dir);
            res.send({ success: true });
        }
        catch (err) {
            res.send(err);
        }

    })
    .listen(process.argv[2] || 2222, () => {
        console.log("server listening to port", process.argv[2] || 2222);
    });

