const request = require('request-promise');
const systemStats = require('./system-stats');

setInterval(async () => {
    try {
        let stats = await systemStats();
        let ip = await _ipLookup();

        const agents = JSON.parse(require('fs').readFileSync(join(__dirname , '/agents.json'), 'utf8'));

        const master = agents.masters[0];

        console.log({ stats, ip, master })

        let response = await request({
            url: `http://${master.ip}:${master.port || 2222}/heartbeat`,
            body: { stats, ip },
            method: 'POST',
            json: true
        });
        if (!response.alive) {
            throw 'Master Not Alive';
        }
    }
    catch (err) {
        // _createNewMaster();
    }
}, 3 * 1000);


const _ipLookup = () => {
    return new Promise((resolve, reject) => {
        require('dns').lookup(require('os').hostname(), function async(err, ip, fam) {
            if (err) {
                return reject(err);
            }
            return resolve(ip);
        });
    })
}
